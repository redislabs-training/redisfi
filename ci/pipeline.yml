resources:
  - name: redisfi
    type: git
    icon: github
    source:
      uri: https://github.com/redislabs-training/redisfi
      branch: main
      username: ((auth-github))
      password: x-oauth-basic
  - name: redisfi-vss
    type: git
    icon: github
    source:
      uri: https://github.com/redislabs-training/redisfi-vss
      branch: main
      username: ((auth-github))
      password: x-oauth-basic
  # - name: redis-enterprise
  #   icon: docker
  #   type: registry-image
  #   source:
  #     repository: redislabs/redis
  #     tag: latest
  - name: redisfi-container
    type: registry-image
    icon: docker
    source:
      repository: timeartist/redisfi
      username: timeartist
      password: ((auth-docker))
  - name: redisfi-vss-container
    type: registry-image
    icon: docker
    source:
      repository: timeartist/redisfi-vss
      username: timeartist
      password: ((auth-docker))

jobs: 
  - name: build-container-base
    plan:
      - get: redisfi
        # params:
        #   format: oci
      - task: build
        privileged: true
        file: redisfi/ci/build.yml
        params:
          CONTEXT: redisfi
          DOCKERFILE: redisfi/dockerfiles/base.dockerfile
          BUILD_ARG_GCP_AUTH: ((auth-gcp-sa))
          BUILD_ARG_NOTIFICATION_EMAIL: ((letsencrypt-email))
          BUILD_ARG_STAGING: ((letsencrypt-staging))
          BUILD_ARG_DOMAIN: ((letsencrypt-domain))
      - put: redisfi-container
        params:
          image: image/image.tar
          version: 99.99.99
          bump_aliases: true
  - name: build-container
    plan:
      - get: redisfi
        # trigger: true
        # params:
        #   format: oci
      - task: build
        privileged: true
        file: redisfi/ci/build.yml
        params:
          CONTEXT: redisfi
          DOCKERFILE: redisfi/dockerfiles/full.dockerfile
      - put: redisfi-container
        params:
          image: image/image.tar
          version: 99.99.99
          bump_aliases: true
  - name: build-vss-container
    plan:
      - get: redisfi-vss
        trigger: true
        params:
          format: oci
      - task: build
        privileged: true
        file: redisfi-vss/ci/build-vss.yml
      - put: redisfi-vss-container
        params:
          image: image/image.tar
          version: 99.99.99
          bump_aliases: true