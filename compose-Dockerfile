FROM docker:dind


# RUN apt update
# RUN apt upgrade -y
# RUN apt install -y python3-pip docker-compose

RUN apk update
# RUN apk add docker-compose
RUN apk add redis py3-pip gcc python3-dev musl-dev libffi-dev docker-compose
# RUN apk upgrade docker docker-compose

RUN pip3 install --upgrade pip
RUN pip3 install poetry

ENV INSTALL_DIR=/opt/redisfi
WORKDIR ${INSTALL_DIR}
COPY pyproject.toml .

# install base dependancies to just use redisfi-compose
RUN poetry install --no-dev

# Development workaround - make sure we don't override poetry.lock inside the container with one we're copying from local
RUN mv poetry.lock poetry.lock.bak
COPY . .
RUN mv poetry.lock.bak poetry.lock

CMD ["poetry", "run", "redisfi-compose", "up"]

